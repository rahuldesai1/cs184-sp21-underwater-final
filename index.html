<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
  <style>
    body {
      padding: 100px;
      width: 1000px;
      margin: auto;
      text-align: left;
      font-weight: 300;
      font-family: 'Open Sans', sans-serif;
      color: #121212;
    }

    h1,
    h2,
    h3,
    h4 {
      font-family: 'Source Sans Pro', sans-serif;
    }
  </style>
  <title>CS 184 Final Project</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Source+Sans+Pro" rel="stylesheet">
</head>


<body>

  <h1>Realistic Underwater Rendering</h1>
  <h3>CS 184 Final Project </h3>
  <p>Team 33: Anthony Patitucci, Charlie Zhang, Dani Swords, Rahul Desai</p>

  <br>

  <div>
    <h2>Abstract</h2>
    <p>The refraction of light through water can result in very interesting optical effects that are essential to model in order to render realistic looking scenes. For our project, we aimed to render realistic lighting effects for scenes involving water by implementing the caustic patterns that we commonly see at the bottom of swimming pools. These patterns are caused by a wavy water surface that refract and focus light in specific locations along the floor of the water. With the path tracing algorithm, caustics are difficult to render because they require an excessively large number of rays to be traced through the scene to converge on an accurate result. We chose to tackle this problem by implementing photon mapping which is a global illumination method that traces photons through the scene in order to more efficiently estimate the effects of caustics. In this project, we build on top of our implementation of Project 3 (PathTracer), by implementing the 2-phase photon mapping algorithm with some minor optimizations. After generating a variety of water surfaces using displacement mapping, we were able to get some very convincing results and gain some interesting insights.
</p>
    <a href="url">Final Video</a>

    <h2>Technical Approach</h2>
    <p>We split up the implementation of the project into two main parts: using Blender to generate a variety of scenes containing water and implementing the photon mapping algorithm.</p>
    <h3>Generating Underwater Scenes</h3>
      <p>In order to simulate realistic caustics, we first needed to create realistic water.</p>
      <h4>Water Material</h4>
        <p>Water is a refractive material much like glass. Therefore, our water material is modeled the same as a glass (refractive) material with a tweaked index of refraction (IOR) of water: 1.33.</p>

      <h4>Water Geometry</h4>
        <p>Having some kind of displacement on the surface of the water is necessary for creating interesting caustics. A flat surface would refract photons uniformly, yielding rather uninteresting results. To create waves in our scenes, we used displacement mapping on the surface of our water. Blender’s default cloud texture created the ocean waves, while the ripple effects were created with a circular sine wave texture. The face of our water is flat, allowing for easy underwater viewing, while still refracting the outcoming light. </p>

    <h3>Photon Mapping</h3>
      <p>Photon mapping is a 2-phase algorithm built on top of ray tracing that involves generating a photon map and then using that photon map to estimate the radiance at various points in the scene. </p>
      <h4>Phase 1</h4>
      <p>The primary goal of the first phase of the algorithm is to build the photon map. This involves two key components: tracing the photons from the light source though the scene and storing the photons in an in-memory data structure.</p>

      <p>To trace photons through the scene, we do something similar to ray tracing. We start by sampling a random location on the light source as well as a random direction out of the light source by using a cosine hemisphere sampler. We also compute the power of the photon by computing the power of the light and dividing that by the number of photons that we shoot out of the light source. The power of the light can be computed by R = P / (A x Ω) where R is Radiance, P is Power, A is area of the light source, and Ω is the solid angle that the light source subtends. Using this newly sampled ray, we compute its hit point with the scene. If the hit point is diffuse, we will store the photon in the photon map along with its power and incoming direction.</p>

      <p>Then, we must determine if the photon is absorbed or reflected off the surface. We do this by using russian roulette with a continuation probability equal to the probability of reflectance of the object that we have intersected with in order to get an unbiased estimate of the distribution of photons through the scene. The probability of reflectance is given by</p>
            <img src="images/probequation.png" align="middle" width="400px" />

      <p> where Pr, Pg, Pd is the power of the incoming photon along the red, green, and blue channel and dr, dg, db are the reflectance properties of the material.</p>
Note, that if the surface is water, we must use the Fresnel Equations to compute the probability of transmission, and use this in Russian Roulette as well. If the algorithm determines that the photon is reflected or transmitted, then we recursively trace the photon in the sampled outgoing direction; otherwise, we terminate the path for that photon.

The photon map itself is stored as a kd-tree because this allows us to efficiently do nearest neighbor queries in 3 dimensional space.

This single photon map is not enough to render realistic underwater scenes. The key to rendering great looking underwater caustics is the use of a caustic photon map. The caustic photon map is a special photon map that stores photons that have only been specularly reflected. We implement this by shooting photons at the light source directly at specular surfaces and then storing the first location at which they hit a diffuse surface. Caustic maps are essential for caustics because they enable the algorithm to more accurately model how light refracts through the water.
</p>
      <h4>Phase 2</h4>
    <h3>Major Problems Encountered</h3>
      <p></p>
    <h3>Lessons Learned</h3>
      <p>The complexity and open-endedness of this final project taught us how to research, design, and implement an idea from scratch as well as how to effectively work together in a large team. However, there are a few more specific and valuable lessons that we gained that will undoubtedly be helpful in future projects. First and foremost is how important visual debugging tools are for computer graphics projects. When debugging our photon map implementation, we ended up spending quite a bit of time writing code that would allow us to visualize the photon maps and the path of the photons through the scene. In the future, it would be important to have a very good idea of how we would debug our code and consider that as a factor when determining the project timeline. In addition, we learned that paying attention to the input is sometimes more important than debugging the code. In this project we unfortunately wasted a lot of time debugging code that was working because we thought there was a bug, when in fact there was an issue with the input scenes that we were rendering. </p>

    <h2>Results</h2>
    <h3>Top Renders</h3>
      <div align="middle">
        <table style="width=100%">
          <tr>
            <td>
              <img src="images/water.png" align="middle" width="400px" />
            </td>
            <td>
              <img src="images/cow.png" align="middle" width="400px" />
            </td>
          </tr>
          <tr>
            <td>
              <img src="images/spheres.png" align="middle" width="400px" />
            </td>
            <td>
              <img src="images/ripples.png" align="middle" width="400px" />
            </td>
          </tr>
        </table>
      </div>

    <br>
    <h3>Interesting Findings</h3>
      <p> After experimenting with different scenes and hyperparameters of the photon mapping code, we learned some interesting things about our implementation: </p>
      <table>
        <tr>
          <td>
            <img src="images/lightsource.png" align="middle" width="500px" />
          </td>
          <td style="padding-left: 20px">
            As we see in the image below, the point light source generates much sharper caustics compared to the area light source. This is likely because the area light source more uniformly illuminates the floor of the water compared to the point light source and as a result the contrast between caustics and non-caustics is less apparent.
          </td>
        </tr>
        <tr>
          <td>
            <img src="images/waterlevel.gif" align="middle" width="500px" />
          </td>
          <td style="padding-left: 20px">
            Another interesting effect that we observed is how the caustics get farther apart from each other as the water gets closer to the light source.
          </td>
        </tr>
        <tr>
          <td>
            <img src="images/photons.gif" align="middle" width="500px" />
          </td>
          <td style="padding-left: 20px">
            The animation below shows various renders with an increasing number of photons. As we can see, as the number of photons increases, the caustics become much sharper. In this example we go from 20,000 photons to 1.6 million.
          </td>
        </tr>
        <tr>
          <td>
            <img src="images/radius.gif" align="middle" width="500px" />
          </td>
          <td style="padding-left: 20px">
            This animation shows us how the renders change as we increase the number of photons used in each radiance calculation. As we go from 100 to 500 photons we can see that the caustics become less sharp; however, there is also less noise on the image overall. This is an interesting tradeoff that we explored when trying to render the most realistic looking images. We settled on a value of 300 photons for a majority of our renders.
          </td>
        </tr>
      </table>

    <h2>References</h2>
    <a href="http://graphics.ucsd.edu/~henrik/papers/photon_map/global_illumination_using_photon_maps_egwr96.pdf">Realistic Image Synthesis Using Photon Mapping</a><br>
    <a href="https://www.cs.princeton.edu/courses/archive/fall18/cos526/papers/jensen01.pdf">A Practical Guide to Global Illumination using Photon Mapping</a><br>
    <a href="https://web.cs.wpi.edu/~emmanuel/courses/cs563/write_ups/zackw/photon_mapping/PhotonMapping.html">Photon Mapping Overview</a><br>
    <a href="https://www.cs.umd.edu/users/mount/Indep/SCheah/causticpaper.html">An Implementation Of A Recursive Ray Tracer That Renders Caustic Lighting Effects</a><br>
    <a href="https://www.energetiq.com/technote-understanding-radiance-brightness-irradiance-radiant-flux">Computing the power of light given radiance</a>

    <h2>Team Member Constributions</h2>
      <p>We all worked together in conducting initial research, putting together the technical design doc, and creating slides and other presentation materials. In terms of implementation, our individual contributions are as follows:</p>

      <ol>

        <li>Anthony Patitucci</li>
          <ul>
            <li>Blender Scene Creation for Visualizations</li>
            <li>Water Creation (Applying Material and Displacement Map)</li>
            <li>Debugging / Editing .dae files</li>
          </ul>

        <li>Charlie Zhang</li>
          <ul>
            <li>Implementation of Phase 2 of Photon Mapping</li>
            <li>Optimizations and photon tracing path visualizations</li>
            <li>Debugging the photon map implementation</li>
          </ul>

        <li>Dani Swords</li>
          <ul>
            <li></li>
            <li></li>
            <li></li>
          </ul>

        <li>Rahul Desai</li>
          <ul>
            <li>Implementation of Phase 1 of Photon Mapping</li>
            <li>Global and Caustic Photon Map Visualizations</li>
            <li>Debugging the Photon Map Implementation</li>
          </ul>
      <ol>


  </div>

</body>
</html>
